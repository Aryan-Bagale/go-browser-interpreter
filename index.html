<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- Page title shown in browser tab -->
    <title>Go Browser Interpreter</title>

    <!-- External CSS file -->
    <link rel="stylesheet" href="style.css" />
</head>
<body>

    <h1>Go Client-Side Interpreter</h1>

    <p>Type Go code below. It runs entirely in your browser!</p>

    <!-- Monaco Editor will be mounted here -->
    <div id="editor"></div>

    <!-- Run button -->
    <button onclick="execute()">Run Code</button>

    <!-- Output area -->
    <div id="output">Loading WASM... (Wait a moment)</div>

    <!-- Go WebAssembly runtime support -->
    <script src="wasm_exec.js"></script>

    <!-- Monaco Editor loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <script>
        // =====================================================
        // 1. Monaco Worker Fix (Required for CDN / GitHub Pages)
        // =====================================================
        //
        // Monaco uses Web Workers which are blocked by browsers
        // when loaded from a CDN. This workaround fixes that.
        //
        window.MonacoEnvironment = {
            getWorkerUrl: function () {
                return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                    self.MonacoEnvironment = {
                        baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/'
                    };
                    importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/base/worker/workerMain.js');
                `)}`;
            }
        };

        // =====================================================
        // 2. Initialize Go WebAssembly Runtime
        // =====================================================
        //
        // This Go object is required to run Go inside the browser
        //
        const go = new Go();

        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then(result => {
                go.run(result.instance);
                document.getElementById("output").innerText = "Ready.";
            })
            .catch(err => {
                document.getElementById("output").innerText = "Error loading WASM: " + err;
                console.error(err);
            });

        // =====================================================
        // 3. Initialize Monaco Code Editor
        // =====================================================
        require.config({
            paths: {
                vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'
            }
        });

        require(['vs/editor/editor.main'], function () {

            // Create Monaco editor
            window.editor = monaco.editor.create(
                document.getElementById('editor'),
                {
                    value: [
                        'package main',
                        '',
                        'import "fmt"',
                        '',
                        'func main() {',
                        '    fmt.Println("Hello, World!")',
                        '}'
                    ].join('\n'),

                    language: 'go',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    scrollBeyondLastLine: false
                }
            );

            // ✅ Auto-focus editor when page loads
            window.editor.focus();

            // ✅ Ctrl + Enter (Windows/Linux) or Cmd + Enter (Mac) to run code
            window.editor.addCommand(
                monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter,
                function () {
                    execute();
                }
            );
        });

        // =====================================================
        // 4. Run Code Function
        // =====================================================
        function execute() {
            if (!window.editor) return;

            const code = window.editor.getValue();

            // Call Go function exposed from WASM
            const result = runGoCode(code);

            document.getElementById("output").innerText = result;
        }
    </script>
</body>
</html>
